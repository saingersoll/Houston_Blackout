---
title: 'EDS 223: assignment 3'
author: "Sofia Ingersoll"
date: "2022-10-26"
output:
    html_document:
      print_df: paged
      toc: yes
      toc_depth: 4
      toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

## Overview

"In February 2021, the state of Texas suffered a major power crisis, which came about as a result of three severe winter storms sweeping across the United States on February 10--11, 13--17, and 15--20."[^1] For more background, check out these [engineering](https://www.youtube.com/watch?v=08mwXICY4JM&ab_channel=PracticalEngineering) and [political](https://www.youtube.com/watch?v=Zcrsgdl_hP0&ab_channel=Vox) perspectives.

[^1]: Wikipedia. 2021. "2021 Texas power crisis." Last modified October 2, 2021. <https://en.wikipedia.org/wiki/2021_Texas_power_crisis>.

For this assignment, you are tasked with:\
- estimating the number of homes in Houston that lost power as a result of the first two storms\
- investigating if socioeconomic factors are predictors of communities recovery from a power outage

Your analysis will be based on remotely-sensed night lights data, acquired from the [Visible Infrared Imaging Radiometer Suite (VIIRS)](https://en.wikipedia.org/wiki/Visible_Infrared_Imaging_Radiometer_Suite) onboard the Suomi satellite. In particular, you will use the VNP46A1 to detect differences in night lights before and after the storm to identify areas that lost electric power.

To determine the number of homes that lost power, you link (spatially join) these areas with [OpenStreetMap](https://www.openstreetmap.org/#map=4/38.01/-95.84) data on buildings and roads.

To investigate potential socioeconomic factors that influenced recovery, you will link your analysis with data from the US Census Bureau.

##### Learning objectives:

-   load vector/raster data\
-   simple raster operations\
-   simple vector operations\
-   spatial joins

Below is an outline of the steps you should consider taking to achieve the assignment tasks.

## Assignment

```{r}
# Reading in Libraries

library(tidyverse)
library(sf)
library(raster)
library(tmap)
library(terra)
library(stars)
library(here)
```

# Finding Locations of Blackouts

##### combine the data (5 points)

### Night Lights Data

Use NASA's Worldview to explore the data around the day of the storm. There are several days with too much cloud cover to be useful, but 2021-02-07 and 2021-02-16 provide two clear, contrasting images to visualize the extent of the power outage in Texas.

VIIRS data is distributed through NASA's [Level-1 and Atmospheric Archive & Distribution System Distributed Active Archive Center (LAADS DAAC)](https://ladsweb.modaps.eosdis.nasa.gov/). Many NASA Earth data products are distributed in 10x10 degree tiles in sinusoidal equal-area projection. Tiles are identified by their horizontal and vertical position in the grid. Houston lies on the border of tiles h08v05 and h08v06. We therefore need to download two tiles per date.

As you're learning in EDS 220, accessing, downloading, and preparing remote sensing data is a skill in it's own right! To prevent this assignment from being a large data wrangling challenge, we have downloaded and prepped the following files for you to work with, stored in the `VNP46A1` folder.

-   `VNP46A1.A2021038.h08v05.001.2021039064328.h5.tif`: tile h08v05, collected on 2021-02-07
-   `VNP46A1.A2021038.h08v06.001.2021039064329.h5.tif`: tile h08v06, collected on 2021-02-07
-   `VNP46A1.A2021047.h08v05.001.2021048091106.h5.tif`: tile h08v05, collected on 2021-02-16
-   `VNP46A1.A2021047.h08v06.001.2021048091105.h5.tif`: tile h08v06, collected on 2021-02-16

## Reading VIIRS Data

Reading in night lights tiles using `stars`:

```{r}
# Reading in the night light tif files

VIIRS_05_07 <- read_stars("data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif")
VIIRS_06_07 <- read_stars("data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif")
VIIRS_05_16 <- read_stars("data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif")
VIIRS_06_16 <- read_stars("data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif")
```

## Combining Tiles

Combining tiles into a single `stars` object for each date (2021-02-07 and 2021-02-16).

```{r include=TRUE}
# Combining tiles for each date as a stars object

feb_07 <- st_mosaic(VIIRS_05_07, VIIRS_06_07)
feb_16 <- st_mosaic(VIIRS_05_16, VIIRS_06_16)
```

# Making a Mask

##### create a blackout mask (10 points)

To find the change in night-light intensity (presumably) caused by the storm, we must make a mask to conceal the data that experienced a drop less than 200 nW cm^-2^sr^-1^. This reclassification of the difference raster was done assuming that any location that experienced a drop of more than 200 nW cm^-2^sr^-1^ experienced a blackout. All **locations not considered blackout zones** were assigned `NA.`

```{r include=TRUE}
# Creating a mask to identify locations that experienced a drop greater than 200 nW cm-2sr-1

blackout_locations <- (feb_07 - feb_16) > 200

# Assigning non-blackout locations to be NA values

blackout_locations[blackout_locations == FALSE] <- NA
```

# Vectorized Mask

##### vectorize the mask (5 points)

To vectorize the blackout mask, apply `st_as_sf()` and correct invalid geometries by piping `st_make_valid`.

```{r include=TRUE}
# Transforming the mask into a vector and fixing improper geometries

vector_blackout_locations <- st_as_sf(blackout_locations) %>% 
  st_make_valid(vector_blackout_locations)

# Displays CRS of vector data
glimpse(crs(vector_blackout_locations))
```

# Cropping a Vectorized Map for Region of Interest

##### crop the vectorized map to our region of interest (10 points)

The Houston metropolitan area was initially defined using the following coordinates:

`(-96.5, 29), (-96.5, 30.5), (-94.5, 30.5), (-94.5, 29)`

These coordinates were then turned into a polygon using `st_polygon` and further converted into a simple feature collection (sfc) using `st_sfc()`. The CRS of this sfc was then converted to match the map to perform the crop.

## Special Feature Collection

```{r include=TRUE}
# Defining the Region of Interest
houston <- st_polygon(list(rbind(c(-96.5, 29),
                                 c(-96.5, 30.5),
                                 c(-94.5, 30.5),
                                 c(-96.5, 29))))

# Creating a sfc and assigning the CRS to match the vector blackout data
houston <- st_sfc(houston) %>% 
  st_set_crs(4326)

# Confirms last step was successful
glimpse(crs(houston))
```

## Making a Mask

A cropped version of the blackout map was created using `st_interects` , this mask of the region of interest was then re-projected to EPSG:3083 (NAD83 / Texas Centric Albers Equal Area).

```{r}
# cropping blackout locations to the houston dimensions
houston_blackout <- st_intersects(vector_blackout_locations,
                                   houston,
                                   sparse = FALSE)

cropped_houston_blackout <- vector_blackout_locations[houston_blackout,]

# Re-projecting to match the maps
cropped_houston_blackout <- cropped_houston_blackout %>% 
  st_transform(3083)
```

# Excluding Highways from the Blackout Map

##### exclude highways from blackout mask (10 points)

### Roads Data

Typically highways account for a large portion of the night lights observable from space (see Google's [Earth at Night](https://earth.google.com/web/@27.44405464,-84.7693044,206.63660162a,8916361.52264659d,35y,0h,0t,0r/data=CiQSIhIgMGY3ZTJkYzdlOGExMTFlNjk5MGQ2ZjgxOGQ2OWE2ZTc)). To minimize falsely identifying areas with reduced traffic as areas without power, we will ignore areas near highways.

[OpenStreetMap (OSM)](https://planet.openstreetmap.org/) is a collaborative project which creates publicly available geographic data of the world. Ingesting this data into a database where it can be subsetted and processed is a large undertaking. Fortunately, third party companies redistribute OSM data. We used [Geofabrik's download sites](https://download.geofabrik.de/) to retrieve a shapefile of all highways in Texas and prepared a Geopackage (`.gpkg` file) containing just the subset of roads that intersect the Houston metropolitan area.Â 

-   `gis_osm_roads_free_1.gpkg`

### Reading in Highway Data

Using `sf` package and `st_read()` to load in the highway data. Additionally, SQL, a language used for storing, manipulating, and retrieving data, was employed to optimize our workflow. The SQL query is stored as query below. The data was then re-projected to match the CRS of the map data EPSG:3083

```{r}
# SQL query to aid in the data loading process
query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"

# Loading in the data with the SQL query
highways <- st_read("data/gis_osm_roads_free_1.gpkg",
                    query = query,
                    quiet = TRUE)

# Re-projecting CRS
highways <- highways %>% st_transform(3083)
```

### Creating a Buffer

Using `st_buffer` to create an undissolved area within 200 m of all highways and `st_union` to dissolve the buffers.

```{r include=TRUE}

```

# Finding Homes Impacted by Blackouts

##### load buildings data (10 points)

### Buildings Data

We can also obtain building data from OpenStreetMap. We downloaded from Geofabrick and prepared a GeoPackage containing only houses in the Houston metropolitan area.

-   `gis_osm_buildings_a_free_1.gpkg`

### Reading in Buildings Data with sf with SQL

Using `st_read` and SQL query to select only residential buildings to then re-project the CRS to EPSG:3083.

```{r}
# SQL Query to aid in data loading process
building_query <- "SELECT *
FROM gis_osm_buildings_a_free_1
WHERE (type IS NULL AND name IS NULL)
OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')"

# Loading in the building data with the query
buildings <- st_read("data/gis_osm_buildings_a_free_1.gpkg",
                     query = building_query,
                     quiet = TRUE)

# Re-projecting the dataset to match map
buildings <- buildings %>% st_transform(3083)
```

## Quantifying Homes Within Blackout Areas 

##### find homes in blackout areas (20 points)

-   filter to homes within blackout areas\
-   count number of impacted homes

```{r include=TRUE}

```

# Investigating socioeconomic factors

##### load ACS data (10 points)

### Socioeconomic Data

We cannot readily get socioeconomic information for every home, so instead we obtained data from the [U.S. Census Bureau's American Community Survey](https://www.census.gov/programs-surveys/acs) for census tracts in 2019. The *folder* `ACS_2019_5YR_TRACT_48.gdb` is an ArcGIS ["file geodatabase"](https://desktop.arcgis.com/en/arcmap/latest/manage-data/administer-file-gdbs/file-geodatabases.htm), a multi-file proprietary format that's roughly analogous to a GeoPackage file.

You can use `st_layers()` to explore the contents of the geodatabase. Each layer contains a subset of the fields documents in the [ACS metadata](https://www2.census.gov/geo/docs/maps-data/data/tiger/prejoined/ACSMetadata2011.txt).

The geodatabase contains a layer holding the geometry information, separate from the layers holding the ACS attributes. You have to combine the geometry with the attributes to get a feature layer that `sf` can use.

### Read in Socioeconomic Data with sf

```{r}
# Loading geometry data
socioeconomic <- st_read("data/ACS_2019_5YR_TRACT_48_TEXAS.gdb", layer = "ACS_2019_5YR_TRACT_48_TEXAS")  

# Loading income data and renaming the columns
income <- st_read("data/ACS_2019_5YR_TRACT_48_TEXAS.gdb", layer = "X19_INCOME") %>%
  dplyr::select(GEIOD, B19013e1) %>% 
  mutate(GEOID_Data = GEOID,
         median_income = B19013e1)
```

-   use `st_read()` to load the geodatabase layers\

-   geometries are stored in the `ACS_2019_5YR_TRACT_48_TEXAS` layer\

-   income data is stored in the `X19_INCOME` layer\

-   select the median income field `B19013e1`\

-   hint: reproject data to EPSG:3083\
    Re-projecting CRS

    ## Re-projecting CRS  

```{r include=TRUE}

```

## Census Tracts Effected by Blackouts

##### determine which census tracts experienced blackouts (10 points)

-   join the income data to the census tract geometries\
-   hint: make sure to join by geometry ID\
-   spatially join census tract data with buildings determined to be impacted by blackouts\
-   find which census tracts had blackouts\

```{r include=TRUE}


```

## Census Tract Incomes vs Blackout Impacts

##### compare incomes of impacted tracts to unimpacted tracts (10 points)

-   create a map of median income by census tract, designating which tracts had blackouts\
-   plot the distribution of income in impacted and unimpacted tracts
-   write approx. 100 words summarizing your results and discussing any limitations to this study
